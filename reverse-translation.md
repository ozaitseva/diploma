# Обратное преобразование физического адреса в виртуальный

Для проведения анализа образа оперативной памяти сначала необходимо изучить, как устроена память конкретной операционной системы. Ниже представлен краткий обзор устройства внутренней памяти Windows 7 на платформе x86-64.
Часть операционной системы, которая отвечает за управление памятью, называется менеджером или диспетчером памяти. Говоря о системе управления памятью, используют понятия физической и виртуальной памяти. 

Под физической памятью подразумевается оперативная память, которая представляет упорядоченный набор однобайтовых ячеек, каждая из которых имеет свой уникальный адрес. Совокупность адресов в физической памяти называется физическим адресным пространством. Виртуальная память - это абстрактное хранилище, используемое для хранения данных процессов, позволяющее программе «считать», что ей предоставлен неограниченный объем памяти и непрерывное адресное пространство памяти. Объем виртуальной памяти равен объему максимально адресуемой памяти. Виртуальное адресное пространство процесса в архитектуре x86-64 теоретически может составлять 16 экзабайт (2^64байт). Понятно, что у современных компьютеров нет необходимости поддерживать такой объем памяти, поэтому чтобы упростить архитектуру микросхем и уменьшить число издержек в нынешних процессорах x64 производства AMD и Intel реализовано только 256 Тбайт виртуального адресного пространства, то есть реализованы только младшие 48 разрядов 64-разрядного виртуального адресного пространства. Однако разрядность виртуального адреса все равно составляет 64 бита, тем самым занимая 8 байт в регистрах. В результате чего появилось требование, чтобы старшие 16 разрядов (48-63) имели значение равное старшему реализованному разряду (47). Адреса, удовлетворяющие данному требованию, называются «каноническими» и имеют следующие значения: 0x0000000000000000 - 0x00007FFFFFFFFFFF, а также 0xFFFF800000000000 -  0xFFFFFFFFFFFFFFFF. 

Виртуальная память в операционной системе Windows имеет сегментно-страничную организацию. Отличительной чертой данной модели является то, что адресное пространство процесса представляется в виде набора сегментов переменного размера. Для удобства преобразования (трансляции) виртуального адреса в физический каждый сегмент делится на страницы - блоки фиксированного размера, при этом физическая память делится на блоки того же размера - страничные кадры (фреймы). Процессоры, на которых работает Windows, поддерживают страницы двух размеров — малые, размером 4 Кб, и большие, размером 2 Мб. По умолчанию адресное пространство каждого процесса изолировано, то есть не может возникнуть такой ситуации, что данные двух разных процессов будут записаны в одну и ту же страницу физической памяти. За преобразование виртуального адреса в физический отвечают таблицы страниц, которые каждой виртуальной страницы ставит в соответствие страничный кадр. Возможны две схемы преобразования адреса для Windows на платформе x86: с расширением физических адресов (Physical Address Extension, PAE) и без него. Системы на платформе x86 без поддержки PAE для преобразования виртуальных адресов в физические используют двухуровневую структуру таблицы страниц, состоящую из каталога страниц (page directory, PD) и таблицы страниц (page table, PT). Виртуальный адрес представляется в виде двух полей: поля номера виртуальной страницы (virtual page number), который в свою очередь делится на два подполя: индекс каталога страниц (page directory index) и индекс таблицы страниц (page table index), и поля байтового смещения (byte offset). В данной работе будет рассмотрена архитектура x86-64, так как большинство современных процессоров поддерживает именно эту систему команд. Системы на платформе x86-64 для трансляции адресов используют схему, схожу со схемой с поддержкой PAE. Они используют четырехуровневую структуру таблицы страниц. 48-разрядный виртуальный адрес представляет собой совокупность 5 полей: селектора четвертого уровня отображения страницы (биты 47-39), селектор указателя каталога страниц (биты 38-30), селектор таблицы страниц (биты 29-21), селектор записи таблицы страниц (биты 20-12) и байтовое смещение (биты 11-0). Эти поля служат для локализации записей в соответствующих таблицах преобразования.

![Виртуальный адрес на платформе x86-64] (https://github.com/ozaitseva/diploma/blob/master/images/virt_adr.jpg "Виртуальный адрес на платформе x86-64")

В поставленной в данной работе задаче необходимо восстановить виртуальное адресное пространство процесса, используя снятый образ физической памяти, то есть провести обратное преобразование физического адреса в виртуальный. Ниже описана схема обратного преобразования, то есть имеющийся 40-разрядный физический адрес необходимо преобразоваться в 48-разрядный виртуальный адрес.

![Структуры преобразования адресов на платформе x86-64](https://github.com/ozaitseva/diploma/blob/master/images/transl_adr.jpg "Структуры преобразования адресов на платформе x86-64")

Записи (такие как PDPE, PDE, PTE и др) в нижеописанных таблицах преобразования представляют собой 8-байтные значения. Биты с номерами 12-39 образуют значения PFN (page frame number), которые указывают на физический адрес таблицы предыдущего уровня. Оставшиеся биты — это флаги, указывающие на состояние страниц.

![Аппаратная запись таблицы страниц на платформе x86-64](https://github.com/ozaitseva/diploma/blob/master/images/pte.jpg "Аппаратная запись таблицы страниц на платформе x86-64")

Преобразования физического адреса выполняется в несколько этапов:

1. Значение байтового смещения (0-11 биты) из виртуального адреса будет совпадать с байтовым смещением из физического адреса. Байтовое смещение указывает на адресацию внутри физической страницы. Таким образом, **получаем 0-11 биты виртуального адреса**. 

2. Оставшиеся 28 бит физического адреса – это номер страничного блока (Page Frame Numbers, PFN) данной физической страницы. Данный PFN хранится в PTE-записи таблицы страниц, следовательно, необходимо найти соответствующую PTE-запись в оперативной памяти. 

3. PTE-запись – это запись таблицы страниц (page directory, PD). Найдя физический адрес PTE-записи, разобьем его на 2 части: 0-11 биты (последние 12 бит) – это смещение в таблице страниц или селектор записи таблицы страниц; 12 – 39 – это физический адрес (Page Frame Numbers, PFN) данной таблицы страниц, который хранится в PDE-записи (page directory entry) каталога страниц второго уровня - таблицы PD (page directory). **Откинув, первые три незначащих нуля, получили 12-20 биты виртуального адреса**. 

4. Теперь по физическому адресу используемой таблицы страниц ищем соответствующую ей PDE-запись каталога страниц второго уровня. Аналогично, полученный физический адрес PDE-записи разбивает на 2 части: 0-11 биты – это смещение в таблице PD, **причем 0-9 биты – это селектор таблицы страниц (биты 21-29) из виртуально адреса**; 12-39 биты – это физический адрес (Page Frame Numbers, PFN) данного каталога страниц.

5. PFN каталога страниц второго уровня хранится в PDPE-записи (page directory pointer entry) структуры третьего уровня – PDPT (page directory pointer table). Поступаем так же, ищем PDPE-запись, ее физический адрес разбиваем на 2 составляющих: 0-11 биты – это смещение в PDPT; 12-39 биты – это физический адрес (Page Frame Numbers, PFN) данной таблицы. **Убираем первые три незначащих нуля в битах, отвечающих за смещение, и оставшиеся 9 бит записываем в 30-38 биты виртуального адреса**.

6. На PFN таблицы третьего уровня ссылается запись расширенного каталога страниц четвертого уровня, называемого таблицей отображения страниц четвертого уровня (page map level 4 table). Находим данную запись. Определив смещение искомой записи в таблице PML4, физический адрес которой может быть получен с помощью записи управляющего регистра CR3, записываем его в 47-39 биты виртуального адреса. 

Таким образом, после преобразования получаем виртуальный адрес, соответствующий текущему физическому адресу. 







