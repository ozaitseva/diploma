# Обратное преобразование физического адреса в виртуальный

Для проведения анализа образа оперативной памяти сначала необходимо изучить, как устроена память конкретной операционной системы. Ниже представлен краткий обзор устройства внутренней памяти Windows 7 на платформе x86-64.
Часть операционной системы, которая отвечает за управление памятью, называется менеджером или диспетчером памяти. Говоря о системе управления памятью, используют понятия физической и виртуальной памяти. 

Под физической памятью подразумевается оперативная память, которая представляет упорядоченный набор однобайтовых ячеек, каждая из которых имеет свой уникальный адрес. Совокупность адресов в физической памяти, используемых для идентификации хранимых в памяти данных, называется физическим адресным пространством. Виртуальная память - это абстрактное хранилище, используемое для хранения данных процессов, позволяющее программе «считать», что ей предоставлен неограниченный объем памяти и непрерывное адресное пространство памяти. Объем виртуальной памяти равен объему максимально адресуемой памяти. Виртуальное адресное пространство процесса в архитектуре x86-64 теоретически может составлять 16 экзабайт (2^64байт). Понятно, что у современных компьютеров нет необходимости поддерживать такой объем памяти, поэтому чтобы упростить архитектуру микросхем и уменьшить число издержек в нынешних процессорах x64 производства AMD и Intel реализовано только 256 Тбайт виртуального адресного пространства, то есть реализованы только младшие 48 разрядов 64-разрядного виртуального адресного пространства. Однако разрядность виртуального адреса все равно составляет 64 бита, тем самым занимая 8 байт в регистрах. В результате чего появилось требование, чтобы старшие 16 разрядов (48-63) имели значение равное старшему реализованному разряду (47). Адреса, удовлетворяющие данному требованию, называются «каноническими» и имеют следующие значения: 0x0000000000000000 - 0x00007FFFFFFFFFFF, а также 0xFFFF800000000000 -  0xFFFFFFFFFFFFFFFF. [1]

Виртуальная память в операционной системе Windows имеет сегментно-страничную организацию. Отличительной чертой данной модели является то, что адресное пространство процесса представляется в виде набора сегментов переменного размера. Для удобства преобразования (трансляции) виртуального адреса в физический каждый сегмент делится на страницы - блоки фиксированного размера, при этом физическая память делится на блоки того же размера - страничные кадры (фреймы). Процессоры, на которых работает Windows, поддерживают страницы двух размеров — малые, размером 4 Кб, и большие, размером 2 Мб. [2] По умолчанию адресное пространство каждого процесса изолировано, то есть не может возникнуть такой ситуации, что данные двух разных процессов будут записаны в одну и ту же страницу физической памяти. За преобразование виртуального адреса в физический отвечают таблицы страниц, которые каждой виртуальной странице ставят в соответствие страничный кадр. Возможны две схемы преобразования адреса для Windows на платформе x86: с расширением физических адресов (Physical Address Extension, PAE) и без него. Системы на платформе x86 без поддержки PAE для преобразования виртуальных адресов в физические используют двухуровневую структуру таблицы страниц, состоящую из каталога страниц (page directory, PD) и таблицы страниц (page table, PT). Виртуальный адрес представляется в виде двух полей: поля номера виртуальной страницы (virtual page number), который в свою очередь делится на два подполя: индекс каталога страниц (page directory index) и индекс таблицы страниц (page table index), и поля байтового смещения (byte offset). В данной работе будет рассмотрена архитектура x86-64, так как большинство современных процессоров поддерживает именно эту систему команд. Системы на платформе x86-64 для трансляции адресов используют схему, схожую со схемой с поддержкой PAE. Они используют четырехуровневую структуру таблицы страниц. 48-разрядный виртуальный адрес представляет собой совокупность 5 полей: селектора четвертого уровня отображения страницы (биты 47-39), селектор указателя каталога страниц (биты 38-30), селектор таблицы страниц (биты 29-21), селектор записи таблицы страниц (биты 20-12) и байтовое смещение (биты 11-0). Эти поля служат для локализации записей в соответствующих таблицах преобразования.[1]

![Виртуальный адрес на платформе x86-64] (https://github.com/ozaitseva/diploma/blob/master/images/virt_adr.jpg "Виртуальный адрес на платформе x86-64")

Записи (такие как PDPE, PDE, PTE и др) в нижеописанных таблицах преобразования представляют собой 8-байтные значения. Биты с номерами 12-39 образуют значения PFN (page frame number), которые указывают на физический адрес таблицы предыдущего уровня. Оставшиеся биты — это флаги, указывающие на состояние страниц.

![Аппаратная запись таблицы страниц на платформе x86-64](https://github.com/ozaitseva/diploma/blob/master/images/pte.jpg "Аппаратная запись таблицы страниц на платформе x86-64")

В поставленной в данной работе задаче необходимо восстановить виртуальное адресное пространство процесса, используя снятый образ физической памяти, то есть провести преобразования известных виртуальных адресов в соответствующие им физические, тем самым получив данные всех страниц виртуальной памяти из кадров (фреймов) оперативной памяти.
Преобразования физического адреса выполняется в несколько этапов:

![Структуры преобразования адресов на платформе x86-64](https://github.com/ozaitseva/diploma/blob/master/images/transl_adr.jpg "Структуры преобразования адресов на платформе x86-64")

Преобразования физического адреса выполняется в несколько этапов:

Шаг 1: Найти физический адрес записи расширенного каталога страниц четвертого уровня, называемого таблицей отображения страниц четвертого уровня (page map level 4), который имеет следующую структуру: 

* Биты 51-12 совпадают со значениями битов 51-12 поля DTB
* Биты 11-3 соответствуют битам 47-39 виртуального адреса
* Биты 2-0 равны нулю
* 
Шаг 2: Найти физический адрес записи структуры третьего уровня, которая называется PDPT (page directory pointer table). Физический адрес имеет аналогичный предыдущей записи вид:

* Биты 51-12 из записи таблицы PML4
*	Биты 11-3 соответствуют битам 38-30 виртуального адреса
*	Биты 2-0 равны нулю
*	
Шаг 3: Найти значение PS-флага (бит 7) записи таблицы PDPT:

*	если флаг принимает значение 1, то данная запись ссылается на большую страницу, размером 1 ГиБ. Записав PFN-номер из данной записи в биты 51-30 и значение смещения из виртуального адреса в биты 29-0, получаем искомый соответствующий данному виртуальному физический адрес;
*	если флаг равен нулю, то переходим к шагу 4.
*	
Шаг 4: Найти физический адрес записи каталога страниц второго уровня - таблицы PD (page directory). Структура соответствующего физического адреса:

*	Биты 51 — 12 соответствуют битам 51-12 записи таблицы PDPT.
*	Биты 11-3 равны битам 29-21 виртуального адреса
*	Биты 2-0 имеют нулевое значение
*	
Шаг 5: Найти значение PS-флага записи таблицы PD:

*	если флаг равен 1, то PDE указывает на страницу, размер которой составляет 2 МиБ. В данном случае получаем физический адрес, у которого значения битов 51-21 хранятся в записи таблицы PDE, а значения 20-0  - из виртуального адреса.
*	В противном случае переходим к шагу 6.
*	
Шаг 6: Найти физический адрес записи таблицы страниц (page table):

*	биты 51-12 физического адреса записи совпадают с 51-12 битами PDE
*	биты 11-3  - биты 20-12 виртуального адреса
*	биты 2-0 равны нулю

Шаг 7: Найти физический адрес соответствующий данному виртуальному:

*	Биты 51-12 из PTE-записи
*	Биты 11-0 — смещение из виртуального адреса 

Таким образом, после преобразования получаем физический адрес, соответствующий текущему виртуальному адресу. 

Если в PTE-записи бит достоверности (0 бит) принимает нулевое значение, то это значит, что в данный момент страница недоступна процессу, то есть данная PTE-запись предоставляет недостоверную страницу.  При ссылке на такую страницу, диспетчер памяти выдает ошибку отсутствия страницы, блок управления память в свою очередь игнорирует все остальные биты PTE-записи, поэтому операционная система может использовать эти биты для хранения информации о странице, ставшей причиной выдачи ошибки.

Существует пять видов недостоверных PTE-записей: [1]

1.	Файл подкачки (Page File PTE). Биты V (0), P (10), U (11) равны нулю. Искомая страница находится в файле подкачки. В данном случае биты 1-4 ссылаются на один из шестнадцати файлов подкачки, а биты 12-51 указывают на смещение в данном файле. Файлы подкачки используются для хранения страниц, которые еще могут понадобиться, но места для их хранения в оперативной памяти нет, поэтому они записываются на диск. Если минимальный и максимальный размер файлов подкачки, на которые указывает параметр реестра HKLM\SYSTEM\CurrentControlSet\Control\SessionManager\MemoryMange-ment \PagingFiles, равны нулю, то это указывает на то, что данный файлы управляются системой. Система выбирает размер данных файлов, исходя из объемов оперативной памяти. Смещение в файле подкачки никогда не бывает нулевым и не может полностью состоять из единиц, то есть первая и последняя страницы из файла подкачки никогда не используются для самой подкачки. Найдя данную запись, необходимо вернуть соответствующие данные из файла подкачки.

2.	Заполнение нулями (Demand Zero PTE). Данная PTE-запись совпадает с предыдущим видом, но поле, отвечающее за смещение в файле подкачки, и поле, ссылающееся на сам файл, полностью заполнены нулями. В данном случае обработчик ошибок выберет свободную страницу из списка страниц, заполненных нулями, а в случае, если такой список пуст, то берет свободную страницу и заполняет ее нулями, если же и свободных страниц нет, то выбирает одну из страниц, ожидающих использования, и заполняет ее нулями. Следовательно, получив данную запись, необходимо вернуть страницу, состоящую из нулей.

3.	Переходное состояние (Transition PTE). Бит U (11) содержит единицу, биты V (0) и P (10) равны нулю. Искомая страница находится в списке ожидающих использования или измененных, но еще не записанных страниц. Именно поэтому страница запись данного вида обрабатывается как действительная.

4. Прототипная PTE-запись (Prototype PTE). Бит P (10) равен единице. Записи таблицы страниц такого вида используется для отображения страниц, которые используются несколькими процессами. Формат прототипных записей таблиц страниц аналогичен формату выше рассмотренных PTE-записей. Записи данного типа имеют собственную классификацию, в следствие чего их обработка рассмотрена ниже.

5. Неизвестная страница (Zero PTE). PTE-запись заполнена нулями. С помощью диспетчера управления ошибок и VAD-дескрипторов можно узнать, был ли данный виртуальный адрес подтвержден. Больше никакой информации о данной странице получить невозможно.
Если бит достоверности PML4-записи, PDPT-записи или PDE равен нулю, то есть данные страницы являются недействительные, то их следует обрабатывать также, как Page File PTE или Transition PTE.

Особое внимание стоит уделить обработке прототипных записей. Страницы, на которые ссылаются данные записи, не используются в процессе преобразования адресов напрямую, а лишь являются промежуточным уровнем поиска номера страничного блока. Адрес прототипной страницы получается следующим образом:

`address = (PTE >> 16) + 0xFFFF000000000000`

Найденная страница может находить в одном из шести состояний[3]: 

*	Активна/достоверна. Бит V (0) равен 1. Данная страница находится в физической памяти и обрабатывается как действительная. 
*	Переходное состояние. Бит U (11) равен 1. Искомая страница находится в оперативной памяти и ожидает использования, либо была изменена. При обработке необходимо вернуть страницу из памяти.
*	Изменение без записи. Бит D (6) равен 1. Искомая страница была изменена, но не записана.  
*	Заполнение нулями. Биты P (10), U (11) равны 0, а также поле, отвечающее за смещение в файле подкачки, и поле, ссылающееся на сам файл, имеют нулевые значения. В качестве искомой должна быть предоставлена страница, заполненная нулями.
*	Страничный файл. Биты P (10), U (11) равны 0. Необходимо вернуть страницу из файла подкачки. 
*	Отображаемый файл. Бит P (10) равен 1. Искомая страница находится в отображаемом файле. 


##Литература: 
[1] Russinovich M., Solomon D., Windows Internals, Fifth Edition ("Внутреннее устройство Windows, часть вторая, шестое издание"), p. 240-271. Microsoft Press, 2014. 

[2] Коньков К.А., [Основы организации операционных систем Microsoft Windows, Лекция 9](http://www.intuit.ru/studies/courses/1089/217/lecture/5601).

[3]Russinovich M., Solomon D., Windows Internals, Fifth Edition ("Внутреннее устройство Windows, часть вторая, шестое издание"), p. 312-314. Microsoft Press, 2014.





