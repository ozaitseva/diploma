# Настройка сервера виртуализации (гипервизора)

### Выбор операционной системы

В качестве рабочей операционной системы (ОС) будем использовать дистрибутив Ubuntu, основанный на Debian GNU/Linux. В настоящее время Ubuntu официально поддерживает только один гипервизор - Qemu-KVM.
Для его эффективного использования процессор должен поддерживать технологию виртуализации (Intel VT-x/AMD-V). Проверить это можно, выполнив следующую команду:

        kvm –ok

Выбор 64-битной платформы объясняется наличием важных для нас возможностей:

* Поддержка 64-битные гостевые операционные системы,
* Выделение гостевым системам более 2 ГиБ оперативной памяти.

**Базовой ОС является Ubuntu 14.04.2 Server AMD64 (x86-64)**.

### Установка гипервизора Qemu-KVM

Следующая команда устанавливает на хост-системе необходимые для работы гипервизора пакеты:

        sudo apt-get install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils

Помимо Qemu-KVM будут установлен пакет `ubuntu-vm-builder`, а также библиотека `libvirt`, которые необходимы для удобного управления гипервизором. Эта установка не включает в себя графической интерфейс, но в случае необходимости его можно добавить (в редакциях Ubuntu Desktop) с помощью команды:

        sudo apt-get install virt-manager

### Создание гостевой машины

1. Создаем файл-образ, выполняющий роль жесткого диска виртуальном машины. При этом доступны разные форматы организации данных внутри файла-образа, например, формат сырых бинарных данных (RAW). Однако наиболее современным и удобным является формат QCOW2, который реализует принцип "copy-on-write" и поддерживает снэпшоты, шифрование и сжатие. При создании также необходимо указать объем жесткого диска:

        qemu-system-x86_64 create -f qcow2 win7.img 15G

2. Запускаем виртуальную машину с примонтированным ISO-образом будущей операционной системы. Мы будем использовать операционную систему Windows 7 Professional x64 (с установочным образом win7profx64.iso):

        qemu-system-x86_64 -cpu Nehalem -enable-kvm –hda ./win7.img -cdrom ./win7profx64.iso -boot d -m 2G

 * `-cpu` – опция отвечает за эмуляцию командных инструкций различных процессоров. Nehalem – это кодовое имя процессора Intel Core i7 9xx. Весь список поддерживаемых процессоров данной архитектуры можно узнать, воспользовавшись командой: `qemu-system-x86_64 -cpu ?`
 * `-enable-kvm` – включение поддержки KVM ядром ОС сервера виртуализации;
 * `-hda ./win7.img` – путь к файлу-образу жесткого диска, создание которого описано выше;
 * `-cdrom ./win7profx64.iso` – путь к ISO-образу ОС, виртуально находящейся в устройстве CDROM;
 * `-boot d` – указание того факта, что загрузка будет производится с привода CDROM, а не с жесткого диска;
 * `-m 2G` – объем выделяемой гостевой машине оперативной памяти (ГиБ).

3. Устанавливаем ОС.

## Запуск виртуальной машины

Для запуска необходимо воспользоваться командой:

        qemu-system-x86_64 -cpu Nehalem -enable-kvm –hda ./win7.img -m 2G

# Операции с гостевой виртуальной машиной

## Снятие образа физической памяти

Для создания образа (дампа) физической памяти воспользуемся утилитой `pmemsave` из пакета `qemu-system`. Она имеет следующий формат аргументов:

        pmemsave <start_address> <length> <filename>

_NB: Максимальный размер одного дампа составляет 4ГиБ._

Объем оперативной памяти нашей виртуальной машины составляет 2 ГиБ, поэтому вводим следующую команду:

        virsh qemu-monitor-command <vm_name> --hmp "pmemsave 0 0x80000000 win7.dump"

## Создание снэпшота диска

Сделать снэпшот диска можно с помощью библиотеки `libvirt`:

        virsh snapshot-create-as <vm_name> <snapshot_name> <snapshot description string> --disk-only --atomic

Для того, чтобы посмотреть список снэпшотов интересующей виртуальной машины нужно воспользоваться командой:

        virsh snapshot-list <vm_name> 
