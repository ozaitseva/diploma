# Настройка сервера виртуализации (гипервизора)

### Выбор операционной системы

В качестве рабочей операционной системы (ОС) будем использовать дистрибутив Ubuntu, основанный на Debian GNU/Linux. В настоящее время Ubuntu официально поддерживает только один гипервизор - Qemu-KVM.
Для его эффективного использования процессор должен поддерживать технологию виртуализации (Intel VT-x/AMD-V). Проверить это можно, выполнив следующую команду (при наличие установленного пакета `cpu-checker`):

        sudo kvm–ok

Выбор 64-битной платформы объясняется наличием важных для нас возможностей:

* Поддержкой 64-битные гостевые операционные системы,
* Выделением гостевым системам более 2 ГиБ оперативной памяти.

**Базовой ОС является Ubuntu 14.04.2 Server AMD64 (x86-64)**.

### Установка гипервизора Qemu-KVM

Следующие команды устанавливают на хост-систему базовый набор необходимых для работы гипервизора пакетов:

        sudo apt-get update
        sudo apt-get install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils virtinst

Помимо Qemu-KVM будут установлены пакеты `ubuntu-vm-builder`, `virtinst`, а также библиотека `libvirt`, которые необходимы для удобного управления гипервизором. Эта установка не включает в себя графической интерфейс, но в случае необходимости его можно добавить (в редакциях Ubuntu Desktop) с помощью команды:

        sudo apt-get install virt-viewer

### Создание гостевой машины

1. Создаем хранилище образа виртуальной машины:

        sudo virsh pool-define-as <storage_name> dir --target <dir_path>

 * `<storage_name>` - название хранилища;
 * `<dir_path>` - путь к папке (например, `/etc/libvirt/images/`).

 Проверяем, создалось ли хранилище:

        sudo virsh pool-list --all

 Должны увидеть:

        <storage_name> не активен нет

 Собираем хранилище:

        sudo virsh pool-build <storage_name>

 Запускаем хранилище:

        sudo virsh pool-start <storage_name>

 Указываем, чтобы хранилище запускалось автоматически:

        sudo virsh pool-autostart <storage_name>

 Проверяем:

        sudo virsh pool-list --all

 Должны увидеть:

        <storage_name> активен да

2. Запускаем виртуальную машину с примонтированным ISO-образом будущей операционной системы. Мы будем использовать операционную систему Windows 7 Professional x64 (с установочным образом win7profx64.iso):

        virt-install \
        --name <vm_name> \
        --ram 2048 \
        --vcpus=2 \
        -c ./win7profx64.iso \
        --os-type=windows \
        --disk pool=<storage_name>,size=15,format=qcow2,cache=none \
        --graphics vnc,listen=0.0.0.0

 * `--name <vm_name>` – название виртуальной машины;
 * `--ram 2048` – объем выделяемой гостевой машине оперативной памяти (МиБ);
 * `--vcpus=2` – количество виртуальных центральных процессоров;
 * `--disk` – параметры виртуального диска: `size=15` – размер диска в ГиБ, `pool=<storage_name>` – путь к хранилищу, `cache=none` – отключение кэширования записи на диск;
 * `listen=0.0.0.0` – разрешение подключиться со всех IP (по умолчанию только localhost).

3. Устанавливаем ОС.

## Запуск виртуальной машины

Для запуска необходимо воспользоваться командой:

        virsh start <vm_name>

# Операции с гостевой виртуальной машиной

## Снятие образа физической памяти

Для создания образа (дампа) физической памяти воспользуемся утилитой `pmemsave` из пакета `qemu-system`. Она имеет следующий формат аргументов:

        pmemsave <start_address> <length> <file_name>

_NB: Максимальный размер одного дампа составляет 4 ГиБ._

Объем оперативной памяти нашей виртуальной машины составляет 2 ГиБ, поэтому вводим следующую команду:

        virsh qemu-monitor-command <vm_name> --hmp "pmemsave 0 0x80000000 win7.dump"

## Создание снэпшота диска

Сделать снэпшот диска можно с помощью библиотеки `libvirt`:

        virsh snapshot-create-as <vm_name> <snapshot_name> <snapshot description string> --disk-only --atomic

Для того, чтобы посмотреть список снэпшотов интересующей виртуальной машины нужно воспользоваться командой:

        virsh snapshot-list <vm_name>
