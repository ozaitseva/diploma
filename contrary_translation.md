# Обратное преобразование физического адреса в виртуальный

![Виртуальный адрес на платформе x86-64](https://www.dropbox.com/s/o5hehbjnwohibau/virt_adr.jpg?dl=0 "Виртуальный адрес на платформе x86-64")

![Структуры преобразования адресов на платформе x86-64](https://www.dropbox.com/s/3x8y3hnj76bp73t/transl_adr.jpg?dl=0 "Структуры преобразования адресов на платформе x86-64")

Записи (такие как PDPE, PDE, PTE и др) в нижеописанных таблицах преобразования представляют собой 8-байтные значения. Биты с номерами 12-39 образуют значения PFN (page frame number), которые указывают на физический адрес таблицы предыдущего уровня. Оставшиеся биты — это флаги, указывающие на состояние страниц.

![Аппаратная запись таблицы страниц на платформе x86-64](https://www.dropbox.com/s/2ko30ytldgp2yd7/pte.jpg?dl=0 "Аппаратная запись таблицы страниц на платформе x86-64")

1. Значение байтового смещения (0-11 биты) из виртуального адреса будет совпадать с байтовым смещением из физического адреса. Байтовое смещение указывает на адресацию внутри физической страницы. Таким образом, **получаем 0-11 биты виртуального адреса**. 

2. Оставшиеся 28 бит физического адреса – это номер страничного блока (Page Frame Numbers, PFN) данной физической страницы. Данный PFN хранится в PTE-записи таблицы страниц, следовательно, необходимо найти соответствующую PTE-запись в оперативной памяти. 

3. PTE-запись – это запись таблицы страниц (page directory, PD). Найдя физический адрес PTE-записи, разобьем его на 2 части: 0-11 биты (последние 12 бит) – это смещение в таблице страниц или селектор записи таблицы страниц; 12 – 39 – это физический адрес (Page Frame Numbers, PFN) данной таблицы страниц, который хранится в PDE-записи (page directory entry) каталога страниц второго уровня - таблицы PD (page directory). **Откинув, первые три незначащих нуля, получили 12-20 биты виртуального адреса**. 

4. Теперь по физическому адресу используемой таблицы страниц ищем соответствующую ей PDE-запись каталога страниц второго уровня. Аналогично, полученный физический адрес PDE-записи разбивает на 2 части: 0-11 биты – это смещение в таблице PD, **причем 0-9 биты – это селектор таблицы страниц (биты 21-29) из виртуально адреса**; 12-39 биты – это физический адрес (Page Frame Numbers, PFN) данного каталога страниц.

5. PFN каталога страниц второго уровня хранится в PDPE-записи (page directory pointer entry) структуры третьего уровня – PDPT (page directory pointer table). Поступаем так же, ищем PDPE-запись, ее физический адрес разбиваем на 2 составляющих: 0-11 биты – это смещение в PDPT; 12-39 биты – это физический адрес (Page Frame Numbers, PFN) данной таблицы. **Убираем первые три незначащих нуля в битах, отвечающих за смещение, и оставшиеся 9 бит записываем в 30-38 биты виртуального адреса**.

6. На PFN таблицы третьего уровня ссылается запись расширенного каталога страниц четвертого уровня, называемого таблицей отображения страниц четвертого уровня (page map level 4 table). Находим данную запись. **Определив смещение искомой записи в таблице PML4, записываем его в 47-39 биты виртуального адреса**. 

**ВОПРОС**: как найти смещение данной записи в таблице отображения страниц четвертого уровня?







